From 084b13fa788fabb062fd198a92a1360b9b3b7da1 Mon Sep 17 00:00:00 2001
From: Julien Viard de Galbert <julien.viard-de-galbert@itrenew.com>
Date: Fri, 24 May 2019 15:09:06 +0200
Subject: [PATCH 2/2] 0010-winterfell-ahci.patch

---
 drivers/ata/libahci.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/ata/libahci.c b/drivers/ata/libahci.c
index 7473ff46de66..33d39f329af5 100644
--- a/drivers/ata/libahci.c
+++ b/drivers/ata/libahci.c
@@ -543,8 +543,12 @@ void ahci_save_initial_config(struct device *dev, struct ahci_host_priv *hpriv)
 	}
 
 	/* fabricate port_map from cap.nr_ports for < AHCI 1.3 */
-	if (!port_map && vers < 0x10300) {
-		port_map = (1 << ahci_nr_ports(cap)) - 1;
+	if (!port_map) { //  && vers < 0x10300) {
+		printk("%s: saved_port=%02x\n", __func__, hpriv->saved_port_map);
+		writel(0x1, mmio + HOST_PORTS_IMPL);
+		port_map = readl(mmio + HOST_PORTS_IMPL);
+
+		//port_map = (1 << ahci_nr_ports(cap)) - 1;
 		dev_warn(dev, "forcing PORTS_IMPL to 0x%x\n", port_map);
 
 		/* write the fixed up value to the PI register */
-- 
2.11.0

